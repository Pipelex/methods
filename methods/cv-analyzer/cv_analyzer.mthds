domain = "candidate_screening"
description = "Screening candidates by matching CVs against job offers and generating appropriate responses."
main_pipe = "screen_candidate"

[concept.MatchResult]
description = "A structured assessment of whether a candidate's CV matches a job offer."

[concept.MatchResult.structure]
is_match = { type = "boolean", description = "Whether the candidate's profile is a good match for the job offer", required = true }
match_analysis = { type = "text", description = "Brief explanation of the reasoning behind the match or mismatch determination", required = true }

[concept.Email]
description = "A professional email message."
refines = "Text"

[concept.InterviewQuestion]
description = "A tailored interview question for a candidate based on their profile and the job requirements."
refines = "Text"

[pipe.screen_candidate]
type = "PipeSequence"
description = """
Main pipeline orchestrator for end-to-end candidate screening: extract the CV, analyze the match against the job offer, then conditionally generate either a refusal email or interview questions.
"""
inputs = { cv = "Document", job_offer = "Document" }
output = "Anything"
steps = [
    { pipe = "extract_cv", result = "cv_pages" },
    { pipe = "extract_job_offer", result = "job_offer_pages" },
    { pipe = "analyze_match", result = "match_result" },
    { pipe = "route_on_match", result = "decision_output" },
]

[pipe.extract_cv]
type = "PipeExtract"
description = "Extract text content from the candidate's CV document into pages."
inputs = { cv = "Document" }
output = "Page[]"
model = "@default-extract-document"

[pipe.extract_job_offer]
type = "PipeExtract"
description = "Extract text content from the job offer document into pages."
inputs = { job_offer = "Document" }
output = "Page[]"
model = "@default-extract-document"

[pipe.analyze_match]
type = "PipeLLM"
description = """
Analyze the match between the candidate's CV and the job offer. Determine if the candidate is a good fit and provide structured reasoning including an is_match boolean.
"""
inputs = { cv_pages = "Page[]", job_offer_pages = "Page[]" }
output = "MatchResult"
model = "$writing-factual"
system_prompt = """
You are an experienced HR expert specializing in candidate screening and recruitment. Your task is to analyze a candidate's CV against a job offer and produce a structured assessment of whether the candidate is a good match.
"""
prompt = """
Analyze the following candidate CV pages and job offer to determine if the candidate is a good match for the position.

@cv_pages

@job_offer_pages
"""

[pipe.route_on_match]
type = "PipeCondition"
description = """
Route to refusal email generation if the candidate does not match the job offer, or to interview question generation if they do match.
"""
inputs = { match_result = "MatchResult", cv_pages = "Page[]", job_offer_pages = "Page[]" }
output = "Anything"
expression_template = "{{ match_result.is_match }}"
outcomes = { True = "generate_interview_questions", False = "write_refusal_email" }
default_outcome = "fail"

[pipe.generate_interview_questions]
type = "PipeLLM"
description = """
Generate 5 tailored interview questions based on the candidate's CV and the job requirements. Questions should probe relevant experience, skills, and fit, focusing on key areas identified in the match analysis.
"""
inputs = { cv_pages = "Page[]", job_offer_pages = "Page[]", match_result = "MatchResult" }
output = "InterviewQuestion[5]"
model = "$writing-factual"
system_prompt = """
You are an experienced HR interviewer. Your task is to craft tailored interview questions for a candidate based on their CV, the job offer, and a prior match analysis. Each question should probe relevant experience, skills, and cultural fit, focusing on the key strengths and gaps identified in the analysis.
"""
prompt = """
Based on the following candidate CV, job offer, and match analysis, generate 5 tailored interview questions that probe the candidate's relevant experience, skills, and fit for the role. Focus on the key areas highlighted in the match analysis.

@cv_pages

@job_offer_pages

@match_result
"""

[pipe.write_refusal_email]
type = "PipeLLM"
description = """
Write a professional, courteous refusal email to the candidate. Reference specific reasons from the match analysis explaining why their profile does not fit the role. Keep the tone respectful and encouraging.
"""
inputs = { cv_pages = "Page[]", job_offer_pages = "Page[]", match_result = "MatchResult" }
output = "Email"
model = "$writing-factual"
system_prompt = """
You are a seasoned HR professional skilled at writing empathetic, professional correspondence. Your task is to draft a refusal email to a candidate whose profile does not match a job offer. The email must be courteous, respectful, and encouraging, while referencing specific reasons from the match analysis to explain the decision. Be concise.
"""
prompt = """
Based on the candidate's CV and the job offer below, write a professional refusal email. Use the match result to reference specific reasons why the candidate's profile does not fit the role.

@cv_pages

@job_offer_pages

@match_result
"""
